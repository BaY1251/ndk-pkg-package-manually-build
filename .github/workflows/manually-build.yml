name: manually build ndk-pkg packages

on:
  workflow_dispatch:
    inputs:

      package-name:
        description: input the package name to be built
        required: true
        default: zlib

      sdk-api-level:
        description: choose the min sdk api level to be built with
        type: choice
        options:
          - '33'
          - '32'
          - '31'
          - '30'
          - '29'
          - '28'
          - '27'
          - '26'
          - '25'
          - '24'
          - '23'
          - '22'
          - '21'

      target-abi-arm64-v8a:
        description: build for arm64-v8a
        type: boolean
        default: true

      target-abi-armeabi-v7a:
        description: build for armeabi-v7a
        type: boolean
        default: false

      target-abi-x86_64:
        description: build for x86_64
        type: boolean
        default: false

      target-abi-x86:
        description: build for x86
        type: boolean
        default: false

      build-type:
        description: choose a build type
        type: choice
        options:
          - release
          - debug

      link-type:
        description: choose a link type
        type: choice
        options:
          - static-only
          - static-prefered
          - shared-only
          - shared-prefered

      pack-type:
        description: choose a pack type
        type: choice
        options:
          - tar.xz
          - tar.lz
          - tar.gz
          - tar.bz2
          - zip

      log-level:
        description: choose a log-level
        type: choice
        options:
          - ''
          - '-q'
          - '-v'
          - '-vv'

jobs:
  build:

    runs-on: ubuntu-latest

    container: fpliu/ndk-pkg

    steps:
      - run: ndk-pkg env
      - run: ndk-pkg setup
      - run: ndk-pkg sysinfo
      - run: ndk-pkg update

      - if: github.event.inputs.target-abi-arm64-v8a == 'true'
        run: |
          ndk-pkg install android-${{ github.event.inputs.sdk-api-level }}/arm64-v8a/${{ github.event.inputs.package-name }} --build-type=${{ github.event.inputs.build-type }} --link-type=${{ github.event.inputs.link-type }} --install-lib=both ${{ github.event.inputs.log-level }}

      - if: github.event.inputs.target-abi-armeabi-v7a == 'true'
        run: |
          ndk-pkg install android-${{ github.event.inputs.sdk-api-level }}/armeabi-v7a/${{ github.event.inputs.package-name }} --build-type=${{ github.event.inputs.build-type }} --link-type=${{ github.event.inputs.link-type }} --install-lib=both ${{ github.event.inputs.log-level }}

      - if: github.event.inputs.target-abi-x86_64 == 'true'
        run: |
          ndk-pkg install android-${{ github.event.inputs.sdk-api-level }}/x86_64/${{ github.event.inputs.package-name }} --build-type=${{ github.event.inputs.build-type }} --link-type=${{ github.event.inputs.link-type }} --install-lib=both ${{ github.event.inputs.log-level }}

      - if: github.event.inputs.target-abi-x86 == 'true'
        run: |
          ndk-pkg install android-${{ github.event.inputs.sdk-api-level }}/x86/${{ github.event.inputs.package-name }} --build-type=${{ github.event.inputs.build-type }} --link-type=${{ github.event.inputs.link-type }} --install-lib=both ${{ github.event.inputs.log-level }}

      - name: pack
        run: |
          set -ex
          for item in $(ndk-pkg ls-installed)
          do
            ndk-pkg pack "$item" -t ${{ github.event.inputs.pack-type }} -o .
          done

      - uses: actions/upload-artifact@v3
        with:
          name: ${{ github.event.inputs.package-name }}-android${{ github.event.inputs.sdk-api-level }}
          path: ${{ github.event.inputs.package-name }}-*.${{ github.event.inputs.pack-type }}
